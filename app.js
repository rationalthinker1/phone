var cheerio = require('cheerio');
var request = require('request');
var mongoose = require('mongoose');
var db = mongoose.connection;
mongoose.connect('mongodb://127.0.0.1:27017/directory');
db.on('error', console.error);
db.once('open', function () {
	var directorySchema = new mongoose.Schema({
		name   : { type: String, required: true },
		phone  : { type: String, unique: true, required: true, dropDups: true },
		address: { type: String, required: true }
	});
	var Directory = mongoose.model('Directory', directorySchema);


	var base_url = 'http://www.canada411.ca/res/';

	var range = function (start, step) {
		var array = [];

		for (var i = 0; i <= step; i++) {
			array[ i ] = parseInt(start);
			start++;
		}

		return array;
	};

	// var initial = [
	//  '416487',
	//  '416489',
	//  '416481',
	//  '416483',
	//  '416233',
	//  '416261',
	//  '416485',
	//  '416465',
	//  '289752',
	//  '416283',
	//  '416444',
	//  '416482',
	//  '416266',
	//  '416438',
	//  '416466',
	//  '416621',
	//  '416231',
	//  '416484',
	//  '416486',
	//  '416239',
	//  '416284',
	//  '416431',
	//  '416267',
	//  '416282',
	//  '416439',
	//  '289997',
	//  '289296',
	//  '416463',
	//  '416461',
	//  '416222',
	//  '416633',
	//  '416225',
	//  '416322',
	//  '416447',
	//  '416546',
	//  '416425',
	//  '416449',
	//  '416493',
	//  '416622',
	//  '416638',
	//  '416265',
	//  '416286',
	//  '416244',
	//  '416422',
	//  '416281',
	//  '416421',
	//  '416236',
	//  '416241',
	//  '416223',
	//  '416247',
	//  '416423',
	//  '416221',
	//  '416248',
	//  '416398',
	//  '416491',
	//  '416519',
	//  '416287',
	//  '416533',
	//  '416245',
	//  '416630',
	//  '289232',
	//  '416234',
	//  '416535',
	//  '416255',
	//  '416429',
	//  '416604',
	//  '416445',
	//  '416293',
	//  '416494',
	//  '416498',
	//  '416536',
	//  '416626',
	//  '416532',
	//  '416636',
	//  '289553',
	//  '289597',
	//  '416269',
	//  '416285',
	//  '416537',
	//  '416299',
	//  '416321',
	//  '416534',
	//  '416497',
	//  '416531',
	//  '289362',
	//  '416249',
	//  '416259',
	//  '416226',
	//  '416251',
	//  '416499',
	//  '416242',
	//  '416264',
	//  '416492',
	//  '416256',
	//  '416469',
	//  '416551',
	//  '416635',
	//  '416250',
	//  '416291',
	//  '416467',
	//  '416289',
	//  '416292',
	//  '289235',
	//  '416480',
	//  '416538',
	//  '416298',
	//  '416462',
	//  '416588',
	//  '289320',
	//  '416391',
	//  '416544',
	//  '416620',
	//  '416297',
	//  '416229',
	//  '416406',
	//  '416232',
	//  '289234',
	//  '416516',
	//  '289240',
	//  '416224',
	//  '416385',
	//  '416253',
	//  '416512',
	//  '416243',
	//  '416503',
	//  '416208',
	//  '416288',
	//  '416335',
	//  '416446',
	//  '416471',
	//  '416252',
	//  '416412',
	//  '416631',
	//  '416274',
	//  '416502',
	//  '416565',
	//  '416614',
	//  '416275',
	//  '416490',
	//  '416508',
	//  '416312',
	//  '416400',
	//  '416409',
	//  '416424',
	//  '416496',
	//  '416500',
	//  '416560',
	//  '416569',
	//  '416609',
	//  '416629',
	//  '416207',
	//  '416237',
	//  '416302',
	//  '416323',
	//  '416440',
	//  '416443',
	//  '416510',
	//  '416545',
	//  '416566',
	//  '416587',
	//  '289241',
	//  '289820',
	//  '416227',
	//  '416451',
	//  '416509',
	//  '416530',
	//  '416273',
	//  '416602',
	//  '289271',
	//  '416201',
	//  '416219',
	//  '416246',
	//  '416315',
	//  '416402',
	//  '416454',
	//  '416543',
	//  '416558',
	//  '416627',
	//  '416628',
	//  '289521',
	//  '416220',
	//  '416277',
	//  '416301',
	//  '416318',
	//  '416434',
	//  '416435',
	//  '416441',
	//  '416464',
	//  '416495',
	//  '416504',
	//  '416561',
	//  '416617',
	//  '289668',
	//  '416271',
	//  '416332',
	//  '416356',
	//  '416358',
	//  '416371',
	//  '416388',
	//  '416505',
	//  '416520',
	//  '416616',
	//  '416624',
	//  '289304',
	//  '289566',
	//  '289969',
	//  '416294',
	//  '416319',
	//  '416450',
	//  '416518',
	//  '416526',
	//  '416554',
	//  '416568',
	//  '416590',
	//  '416603',
	//  '416209',
	//  '416238',
	//  '416410',
	//  '416427',
	//  '416453',
	//  '416457',
	//  '416539',
	//  '416574',
	//  '416615',
	//  '289228',
	//  '289407',
	//  '289836',
	//  '416203',
	//  '416278',
	//  '416300',
	//  '416347',
	//  '416383',
	//  '416413',
	//  '416523',
	//  '416559',
	//  '416564',
	//  '416571',
	//  '416605',
	//  '289660',
	//  '416000',
	//  '416206',
	//  '416230',
	//  '416240',
	//  '416276',
	//  '416417',
	//  '416419',
	//  '416420',
	//  '416436',
	//  '416455',
	//  '416456',
	//  '416540',
	//  '416553',
	//  '416562',
	//  '416573',
	//  '416575',
	//  '416618',
	//  '416637'
	// ];
	/* 87549 - 30 - 50 at 4:26am 23% */
	/* 133565 - 50 - 70 at 10:51am */
	/* 133565 - 90 - 110 at 10:51am */
	/* 236727 - 110 - 120 at 12:07am */
	/* 236727 - 120 - 130 at 12:07am */
	/* 236727 - 130 - 150 at 12:07am */
	/* 236727 - 150 - 170 at 12:07am */
	/* 286272 - 170 - 190 at 12:07am */
	/* 286272 - 190 - 210 at 12:07am */
	/* 295307 - 210 - 230 at 12:07am ->progress STOPPED AT 416-568-4218 */
	/* 236727 - 237 - 257 at 12:07am */

	var initial = [
		'905773',
		'905851',
		'905239',
		'905727',
		'905237',
		'905832',
		'905856',
		'905840',
		'905227',
		'905846',
		'905427',
		'905495',
		'905731',
		'905683',
		'905354',
		'905841',
		'905508',
		'905737',
		'905686',
		'905857',
		'905303',
		'905357',
		'905216',
		'905764',
		'905820',
		'905417',
		'905597',
		'905646',
		'905770',
		'905356',
		'905426',
		'905428',
		'905824',
		'905839',
		'905358',
		'905793',
		'905826',
		'905822',
		'905853',
		'905850',
		'905563',
		'905309',
		'905836',
		'905775',
		'905796',
		'905278',
		'905230',
		'905235',
		'905682',
		'905831',
		'905828',
		'905823',
		'905476',
		'905459',
		'905275',
		'905709',
		'905607',
		'905397',
		'905420',
		'905274',
		'905294',
		'905684',
		'905780',
		'905279',
		'905455',
		'905619',
		'905771',
		'905471',
		'905763',
		'905567',
		'905685',
		'905858',
		'905726',
		'905271',
		'905454',
		'905270',
		'905680',
		'905821',
		'905568',
		'905785',
		'905792',
		'905450',
		'905507',
		'905735',
		'905453',
		'905492',
		'905713',
		'905855',
		'905264',
		'905265',
		'905457',
		'905799',
		'905452',
		'905553',
		'905569',
		'905688',
		'905707',
		'905712',
		'905497',
		'905509',
		'905791',
		'905472',
		'905584',
		'905790',
		'905232',
		'905374',
		'905814',
		'905605',
		'905830',
		'905479',
		'905542',
		'905272',
		'905666',
		'905456',
		'905625',
		'905668',
		'905738',
		'905834',
		'905837',
		'905276',
		'905353',
		'905458',
		'905502',
		'905669',
		'905430',
		'905848',
		'905371',
		'905451',
		'905608',
		'905624',
		'905641',
		'905812',
		'905503',
		'905533',
		'905787',
		'905789',
		'905819',
		'905835',
		'905277',
		'905501',
		'905665',
		'905732',
		'905813',
		'905640',
		'905728',
		'905478',
		'905295',
		'905687',
		'905751',
		'905554',
		'905629',
		'905778',
		'905654',
		'905725',
		'905201',
		'905653',
		'905734',
		'905487',
		'905488',
		'905604',
		'905493',
		'905566',
		'905761',
		'905460',
		'905576',
		'905273',
		'905313',
		'905729',
		'905238',
		'905380',
		'905403',
		'905470',
		'905473',
		'905477',
		'905760',
		'905286',
		'905329',
		'905794',
		'905816',
		'905833',
		'905852',
		'905223',
		'905494',
		'905579',
		'905642',
		'905436',
		'905535',
		'905552',
		'905623',
		'905697',
		'905788',
		'905868',
		'905534',
		'905571',
		'905593',
		'905602',
		'905673',
		'905717',
		'905755',
		'905281',
		'905434',
		'905468',
		'905551',
		'905404',
		'905704',
		'905762',
		'905859',
		'905252',
		'905474',
		'905475',
		'905513',
		'905660',
		'905677',
		'905714',
		'905246',
		'905321',
		'905562',
		'905564',
		'905591',
		'905650',
		'905672',
		'905723',
		'905231',
		'905359',
		'905382',
		'905401',
		'905615',
		'905228',
		'905305',
		'905438',
		'905499',
		'905655',
		'905678',
		'905716',
		'905721',
		'905862',
		'905209',
		'905324',
		'905348',
		'905565',
		'905651',
		'905658',
		'905670',
		'905804',
		'905240',
		'905341',
		'905424',
		'905432',
		'905463',
		'905482',
		'905482',
		'905671',
		'905715',
		'905806',
		'905285',
		'905290',
		'905346',
		'905433',
		'905803',
		'905817',
		'905838',
		'905306',
		'416487'
	];
	/* 04:31pm - 295313 - 000 - 020 */
	/* 04:31pm - 295313 - 020 - 040 */
	/* 05:07pm - 371235 - 040 - 060 */
	/* 06:02pm - 481005 - 060 - 080 - 07:07pm */
	/* 06:02pm - 481005 - 080 - 099  */
	/* 06:02pm - 481005 - 099 - 100 - NOT DONE */
	/* 06:08pm - 491820 - 100 - 120 - 07:16pm */
	/* 06:08pm - 491820 - 120 - 140 */
	/* 07:08pm - 598682 - 140 - 160 */
	/* 07:17pm - 610666 - 160 - 180 */
	/* 07:17pm - 670549 - 160 - 180 */
	/* 08:41pm - 670549 - 180 - 200 */
	/* 08:43pm - 670549 - 200 - 220 */
	/* 08:43pm - 670549 - 220 - 240 */
	/* 09:36pm - 670549 - 240 - 260 */
	/* 09:36pm - 670549 - 260 - 263 */
	for (var j = process.argv[ 2 ]; j < process.argv[ 3 ]; j++) {
		var phones = range(initial[ j ] + '0000', 10000);
		for (var i = 0; i < phones.length; i++) {
			(function(phone) {
				request(base_url + phone, function (error, response, body) {
					if (!error && response.statusCode === 200) {
						var $ = cheerio.load(body);

						$('#contact').filter(function () {
							var data = $(this);

							var listing = new Directory({
								name     : data.find('.c411ListedName').first().text()
								, phone  : data.find('.c411Phone').first().text()
								, address: data.find('.c411Address').first().text().trim()
							});

							listing.save(function (err, element) {
								if (err) return console.error(err);
								console.dir(element);
							});
						});
					} else {
						console.log('No information found for phone:', phone);
					}
				});
			})(phones[ i ]);
		}
	}
});