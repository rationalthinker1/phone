//var express = require('express');
//var app = express();
var cheerio = require('cheerio');
var request = require('request');
//var mongodb = require('mongodb');
var mongoose = require('mongoose');
var db = mongoose.connection;
mongoose.connect('mongodb://127.0.0.1:27017/directory');
db.on('error', console.error);
db.once('open', function() {
	console.log('open');
	var directorySchema = new mongoose.Schema({
		name : { type : String , required : true }
		, phone : { type : String , unique : true, required : true, dropDups: true }
		, address: { type : String , required : true }
	});

	var Directory = mongoose.model('Directory', directorySchema);


	var base_url = 'http://www.canada411.ca/res/';

	var range = function (start, step) {
		var array = [];

		for (var i = 0; i <= step; i++) {
			array[ i ] = parseInt(start);
			start++;
		}

		return array;
	};

	var initial = [
		'416487',
		'416489',
		'416481',
		'416483',
		'416233',
		'416261',
		'416485',
		'416465',
		'289752',
		'416283',
		'416444',
		'416482',
		'416266',
		'416438',
		'416466',
		'416621',
		'416231',
		'416484',
		'416486',
		'416239',
		'416284',
		'416431',
		'416267',
		'416282',
		'416439',
		'289997',
		'289296',
		'416463',
		'416461',
		'416222',
		'416633',
		'416225',
		'416322',
		'416447',
		'416546',
		'416425',
		'416449',
		'416493',
		'416622',
		'416638',
		'416265',
		'416286',
		'416244',
		'416422',
		'416281',
		'416421',
		'416236',
		'416241',
		'416223',
		'416247',
		'416423',
		'416221',
		'416248',
		'416398',
		'416491',
		'416519',
		'416287',
		'416533',
		'416245',
		'416630',
		'289232',
		'416234',
		'416535',
		'416255',
		'416429',
		'416604',
		'416445',
		'416293',
		'416494',
		'416498',
		'416536',
		'416626',
		'416532',
		'416636',
		'289553',
		'289597',
		'416269',
		'416285',
		'416537',
		'416299',
		'416321',
		'416534',
		'416497',
		'416531',
		'289362',
		'416249',
		'416259',
		'416226',
		'416251',
		'416499',
		'416242',
		'416264',
		'416492',
		'416256',
		'416469',
		'416551',
		'416635',
		'416250',
		'416291',
		'416467',
		'416289',
		'416292',
		'289235',
		'416480',
		'416538',
		'416298',
		'416462',
		'416588',
		'289320',
		'416391',
		'416544',
		'416620',
		'416297',
		'416229',
		'416406',
		'416232',
		'289234',
		'416516',
		'289240',
		'416224',
		'416385',
		'416253',
		'416512',
		'416243',
		'416503',
		'416208',
		'416288',
		'416335',
		'416446',
		'416471',
		'416252',
		'416412',
		'416631',
		'416274',
		'416502',
		'416565',
		'416614',
		'416275',
		'416490',
		'416508',
		'416312',
		'416400',
		'416409',
		'416424',
		'416496',
		'416500',
		'416560',
		'416569',
		'416609',
		'416629',
		'416207',
		'416237',
		'416302',
		'416323',
		'416440',
		'416443',
		'416510',
		'416545',
		'416566',
		'416587',
		'289241',
		'289820',
		'416227',
		'416451',
		'416509',
		'416530',
		'416273',
		'416602',
		'289271',
		'416201',
		'416219',
		'416246',
		'416315',
		'416402',
		'416454',
		'416543',
		'416558',
		'416627',
		'416628',
		'289521',
		'416220',
		'416277',
		'416301',
		'416318',
		'416434',
		'416435',
		'416441',
		'416464',
		'416495',
		'416504',
		'416561',
		'416617',
		'289668',
		'416271',
		'416332',
		'416356',
		'416358',
		'416371',
		'416388',
		'416505',
		'416520',
		'416616',
		'416624',
		'289304',
		'289566',
		'289969',
		'416294',
		'416319',
		'416450',
		'416518',
		'416526',
		'416554',
		'416568',
		'416590',
		'416603',
		'416209',
		'416238',
		'416410',
		'416427',
		'416453',
		'416457',
		'416539',
		'416574',
		'416615',
		'289228',
		'289407',
		'289836',
		'416203',
		'416278',
		'416300',
		'416347',
		'416383',
		'416413',
		'416523',
		'416559',
		'416564',
		'416571',
		'416605',
		'289660',
		'416000',
		'416206',
		'416230',
		'416240',
		'416276',
		'416417',
		'416419',
		'416420',
		'416436',
		'416455',
		'416456',
		'416540',
		'416553',
		'416562',
		'416573',
		'416575',
		'416618',
		'416637'
	];
	/* 87549 - 30 - 50 at 4:26am 23% */
	/* 133565 - 50 - 70 at 10:51am */
	/* 236727 - 110 - 130 at 12:07am */
	for (var j = process.argv[2]; j < process.argv[3]; j++) {
		var phones = range(initial[j] + '0000', 10000);
		for (var i = 0; i < phones.length; i++) {
			request(base_url + phones[ i ], function (error, response, body) {
				if (!error && response.statusCode === 200) {
					var $ = cheerio.load(body);

					$('#contact').filter(function () {
						var data = $(this);

						var listing = new Directory({
							name     : data.find('.c411ListedName').first().text()
							, phone  : data.find('.c411Phone').first().text()
							, address: data.find('.c411Address').first().text().trim()
						});

						listing.save(function (err, thor) {
							if (err) return console.error(err);
							console.dir(thor);
						});
					});
				}
			});
		}
	}
});


//var sleep = require('sleep');
//var port = 3000;


// START THE SERVER
// =============================================================================
//app.listen(port);
//console.log('Magic happens on port ' + port);